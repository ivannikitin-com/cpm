(function($){var weDevs_CPM={init:function(){$("#cpm-create-user-wrap").on("submit","form.cpm-user-create-form",this.Project.UserCreate);$("a#cpm-create-project").on("click",this.Project.openDialog);$("#cpm-project-dialog").on("click","a.project-cancel",this.Project.closeDialog);$("a.cpm-project-delete-link").on("click",this.Project.remove);$("#cpm-project-dialog").on("submit","form.cpm-project-form",this.Project.create);$(".cpm-edit-project").on("submit","form.cpm-project-form",this.Project.edit);$(".cpm-project-head").on("click","a.cpm-icon-edit",this.Project.toggleEditForm);$(".cpm-project-head").on("click","a.project-cancel",this.Project.toggleEditForm);$(".cpm-load-more").on("click",this.Project.loadActivity);$(".cpm-links").on("click",".cpm-milestone-delete",this.Milestone.remove);$(".cpm-links").on("click",".cpm-milestone-complete",this.Milestone.markComplete);$(".cpm-links").on("click",".cpm-milestone-open",this.Milestone.markOpen);$(".cpm-links").on("click","a.cpm-icon-edit",this.Milestone.get);$(".cpm-new-milestone-form").on("submit","form.cpm-milestone-form",this.Milestone.add);$(".cpm-new-milestone-form").on("click","a.milestone-cancel",this.Milestone.hide);$("a#cpm-add-milestone").on("click",this.Milestone.show);$(".cpm-milestone").on("click","a.milestone-cancel",this.Milestone.cancelUpdate);$(".cpm-milestone").on("submit","form.cpm-milestone-form",this.Milestone.update);$(".cpm-comment-wrap").on("click",".cpm-edit-comment-link",this.Comment.get);$(".cpm-comment-wrap").on("click",".cpm-comment-edit-cancel",this.Comment.cancelCommentEdit);$(".cpm-comment-wrap").on("click",".cpm-delete-comment-link",this.Comment.deleteComment);$(".cpm-comment-wrap").on("submit",".cpm-comment-form",this.Comment.update);$(".cpm-comment-wrap").on("click",".cpm-delete-file",this.Uploader.deleteFile);$(".cpm-comment-form-wrap").on("click",".cpm-delete-file",this.Uploader.deleteFile);$(".cpm-duplicate-project").on("click",this.Project.ProjectDuplicate);$(".cpm-archive").on("click",this.Project.ProjectArchive);$(".cpm-settings-bind").on("click",this.Project.Settings);$(".cpm-comment-form").validate({submitHandler:function(e){weDevs_CPM.Comment.addNew.call(e);return!1}});$(".cpm").on("click",".cpm-toggle-checkbox",function(e){e.preventDefault();var t=$(".notify-users").find('input[type=checkbox][name="notify_user[]"]');t.prop("checked",!t.prop("checked"))});$(".cpm-new-message-form form").validate({submitHandler:function(e){weDevs_CPM.Message.addNew.call(e);return!1}});$(".cpm-new-message-btn").on("click",this.Message.show);$(".cpm-new-message-form").on("click","a.message-cancel",this.Message.hide);$(".cpm-single").on("click","a.cpm-msg-edit",this.Message.get);$(".cpm-single").on("click","a.message-cancel",this.Message.hideEditForm);$(".cpm-single").on("click",".cpm-delete-file",this.Uploader.deleteFile);$(".cpm-new-message-form").on("click",".cpm-delete-file",this.Uploader.deleteFile);$(".cpm-single").on("submit","form.cpm-message-form",this.Message.update);$("table.cpm-messages-table").on("click","a.delete-message",this.Message.remove)},Project:{UserCreate:function(e){e.preventDefault();var t=$(this),n=t.find("input[type=submit]").siblings("span");n.addClass("cpm-spinner");if(t.attr("disabled")=="disabled")return!1;t.attr("disabled",!0);var r={action:"cpm_user_create",data:t.serialize(),_wpnonce:CPM_Vars.nonce};$.post(CPM_Vars.ajaxurl,r,function(e){t.attr("disabled",!1);n.removeClass("cpm-spinner");if(e.success){$("#cpm-create-user-wrap").dialog("close");$(".cpm-project-role>table").append(e.data);$(".cpm-error").html("");$("form.cpm-user-create-form input[type=text], input[type=email]").val("")}else $(".cpm-error").html(e.data)});return!1},Settings:function(e){e.preventDefault();var t=$(this),n=t.siblings(".cpm-settings");n.is(":visible")===!1?n.show():n.hide()},ProjectArchive:function(e){e.preventDefault();var t=$(this),n={action:"cpm_project_archive",_nonce:CPM_Vars.nonce,project_id:t.data("project_id"),type:t.data("type")};if(t.attr("disabled")=="disabled")return!1;t.attr("disabled",!0);t.siblings("span").addClass("cpm-loading");$.post(CPM_Vars.ajaxurl,n,function(e){t.attr("disabled",!1);if(e.success)if($("article.cpm-project").length){$(".cpm-active").html("Active("+e.data.count.active+")");$(".cpm-archive-head").html("Completed("+e.data.count.archive+")");t.closest("article").fadeOut("slow",function(){this.remove()})}else location.href=e.data.url})},ProjectDuplicate:function(e){e.preventDefault();var t=$(this),n={action:"cpm_project_duplicate",_nonce:CPM_Vars.nonce,url:t.attr("href"),project_id:t.data("project_id")};if(t.attr("disabled")=="disabled")return!1;t.attr("disabled",!0);t.siblings("span").addClass("cpm-loading");$.post(CPM_Vars.ajaxurl,n,function(e){t.attr("disabled",!1);e.success&&(location.href=e.data.url)})},openDialog:function(e){e.preventDefault();$("#cpm-project-dialog").dialog("open")},closeDialog:function(e){e.preventDefault();$("#cpm-project-dialog").dialog("close")},create:function(e){e.preventDefault();var t=$(this).find("input[type=submit]");if(t.is(":disabled"))return!1;t.attr("disabled",!0);var n=$.trim($("#project_name").val());if(n===""){alert("Enter a project name");return!1}var r=$(this),i=r.serialize();r.find(".cpm-loading").show();$.post(CPM_Vars.ajaxurl,i,function(e){t.attr("disabled",!1);e=$.parseJSON(e);e.success&&(window.location.href=e.url)})},toggleEditForm:function(e){e.preventDefault();var t=$(this).closest(".cpm-project-head");t.find(".cpm-edit-project").slideToggle();t.find(".cpm-project-detail").slideToggle()},edit:function(e){e.preventDefault();var t=$(this),n=t.find(".cpm-pro-update-spinner");n.show();var r=$(this).closest(".cpm-project-head"),i=t.serialize(),s=t.find("input[type=submit]");s.attr("disabled",!0);t.append('<div class="cpm-loading">Saving...</div>');$.post(CPM_Vars.ajaxurl,i,function(e){s.attr("disabled",!1);n.hide();e=$.parseJSON(e);if(e.success){r.find("h2 span").text(e.title);r.find(".detail").html(e.content);t.find(".cpm-project-role").children("table").html(e.users);t.closest(".cpm-edit-project").slideUp();r.find(".cpm-project-detail").slideToggle()}});$(".cpm-loading").remove()},remove:function(e){e.preventDefault();var t=$(this),n=t.data("confirm"),r={project_id:t.data("project_id"),action:"cpm_project_delete",url:t.attr("href"),_wpnonce:CPM_Vars.nonce};if(confirm(n)){t.siblings("span").addClass("cpm-loading");$.post(CPM_Vars.ajaxurl,r,function(e){e=$.parseJSON(e);e.success&&(location.href=e.url)})}},loadActivity:function(e){e.preventDefault();var t=$(this),n=t.data("total"),r=parseInt(t.data("start")),i={project_id:t.data("project_id"),offset:r,action:"cpm_get_activity",_wpnonce:CPM_Vars.nonce};t.append('<div class="cpm-loading">Loading...</div>');$.get(CPM_Vars.ajaxurl,i,function(e){e=$.parseJSON(e);if(e.success){r=e.count+r;t.prev("ul.cpm-activity").append(e.content);t.data("start",r)}else t.remove();$(".cpm-loading").remove()})}},Milestone:{remove:function(e){e.preventDefault();var t=$(this);confirm(t.data("confirm"))&&weDevs_CPM.Milestone.ajaxRequest.call(this,"cpm_delete_milestone")},markComplete:function(e){e.preventDefault();weDevs_CPM.Milestone.ajaxRequest.call(this,"cpm_milestone_complete")},markOpen:function(e){e.preventDefault();weDevs_CPM.Milestone.ajaxRequest.call(this,"cpm_milestone_open")},show:function(e){e.preventDefault();$(".cpm-new-milestone-form").slideDown()},hide:function(e){e.preventDefault();$(".cpm-new-milestone-form").slideUp()},get:function(e){e.preventDefault();var t=$(this),n=t.closest(".cpm-milestone"),r={id:t.data("id"),project_id:t.data("project_id"),action:"cpm_milestone_get",_wpnonce:CPM_Vars.nonce};t.addClass("cpm-milestones-spinner");$.post(CPM_Vars.ajaxurl,r,function(e){e=$.parseJSON(e);if(e.success){n.find(".milestone-detail").hide().next(".cpm-milestone-edit-form").html(e.content).fadeIn();$(".datepicker").datepicker()}})},add:function(e){e.preventDefault();var t=$(this),n=t.find(".cpm-loading"),r=t.serialize(),i=t.find("input[name=create_milestone]");n.show();i.attr("disabled",!0);$.post(CPM_Vars.ajaxurl,r,function(e){n.hide();i.attr("disabled",!1);e=$.parseJSON(e);e.success&&window.location.reload()})},update:function(e){e.preventDefault();var t=$(this),n=t.find(".cpm-loading"),r=t.find("input[name=create_milestone]"),i=t.serialize();n.show();r.attr("disabled",!0);$.post(CPM_Vars.ajaxurl,i,function(e){e=$.parseJSON(e);e.success&&window.location.reload()})},cancelUpdate:function(e){e.preventDefault();var t=$(this),n=t.closest(".cpm-milestone"),r=n.find(".cpm-milestones-spinner");r.removeClass("cpm-milestones-spinner");n.find(".cpm-milestone-edit-form").hide().prev(".milestone-detail").fadeIn()},ajaxRequest:function(e){var t=$(this),n={milestone_id:t.data("id"),project_id:t.data("project"),action:e,_wpnonce:CPM_Vars.nonce};t.addClass("cpm-milestones-spinner");$.post(CPM_Vars.ajaxurl,n,function(e){location.reload()})}},Uploader:{deleteFile:function(e){e.preventDefault();if(confirm("This file will be deleted permanently")){var t=$(this),n={file_id:t.data("id"),action:"cpm_delete_file",_wpnonce:CPM_Vars.nonce};$.post(CPM_Vars.ajaxurl,n,function(){});t.closest(".cpm-uploaded-item").fadeOut(function(){$(this).remove()})}}},Comment:{addNew:function(){var e=$(this),t=e.find("input[name=cpm_new_comment]"),n=e.find(".cpm-loading"),r=e.serialize();t.attr("disabled",!0);n.show();$.post(CPM_Vars.ajaxurl,r,function(e){t.attr("disabled",!1);n.hide();e=JSON.parse(e);if(e.success){$(".cpm-comment-wrap").append(e.content).fadeIn("slow");$(".cpm-comment-form textarea, .cpm-comment-form input[type=checkbox]").val("");$(".cpm-comment-form .cpm-upload-filelist").html("")}})},get:function(e){e.preventDefault();var t=$(this),n=t.closest(".cpm-comment"),r={comment_id:t.data("comment_id"),project_id:t.data("project_id"),object_id:t.data("object_id"),action:"cpm_comment_get",_wpnonce:CPM_Vars.nonce};$.post(CPM_Vars.ajaxurl,r,function(e){e=$.parseJSON(e);if(e.success&&n.find("form").length===0){n.find(".cpm-comment-content").hide();n.find(".cpm-comment-edit-form").hide().html(e.form).fadeIn();new CPM_Uploader("cpm-upload-pickfiles-"+e.id,"cpm-upload-container-"+e.id)}})},cancelCommentEdit:function(e){e.preventDefault();var t=$(this);t.parents(".cpm-comment").find(".cpm-comment-content").fadeIn();t.closest(".cpm-comment-edit-form").html("")},update:function(e){e.preventDefault();var t=$(this),n=t.find("input[name=cpm_new_comment]"),r=t.find(".cpm-loading"),i=t.closest(".cpm-comment-container"),s=t.serialize(),o=$.trim(t.find("textarea").val());if(o.length<1){alert("Please enter some text");return!1}n.attr("disabled",!0);r.show();$.post(CPM_Vars.ajaxurl,s,function(e){n.attr("disabled",!1);r.hide();e=$.parseJSON(e);if(e.success){i.find(".cpm-comment-content").html(e.content).fadeIn();t.parent().remove()}})},deleteComment:function(e){e.preventDefault();var t=$(this),n=t.data("confirm"),r={comment_id:t.data("id"),project_id:t.data("project_id"),action:"cpm_comment_delete",_wpnonce:CPM_Vars.nonce};if(t.attr("disabled")=="disabled")return!1;if(confirm(n)){t.addClass("cpm-comment-spinner");t.attr("disabled","disabled");$.post(CPM_Vars.ajaxurl,r,function(e){t.removeClass("cpm-comment-spinner");t.removeAttr("disabled");e=$.parseJSON(e);e.success&&t.closest("li").fadeOut(function(){$(this).remove()})})}}},Message:{show:function(e){e.preventDefault();$(".cpm-new-message-form").slideDown()},hide:function(e){e.preventDefault();$(".cpm-new-message-form").slideUp()},addNew:function(e){var t=$(this),n=t.serialize(),r=t.find("input[name=create_message]"),i=t.find(".cpm-loading");r.attr("disabled",!0);i.show();$.post(CPM_Vars.ajaxurl,n,function(e){r.attr("disabled",!1);i.hide();e=$.parseJSON(e);e.success&&(window.location.href=e.url);$(".cpm-loading").remove()});return!1},update:function(e){e.preventDefault();var t=$(this),n=t.find("input[name=create_message]"),r=t.find(".cpm-loading"),i=t.closest(".cpm-single"),s=t.serialize();n.attr("disabled",!0);r.show();$.post(CPM_Vars.ajaxurl,s,function(e){n.attr("disabled",!1);r.hide();e=$.parseJSON(e);if(e.success){console.log(i);i.find(".cpm-entry-detail").html(e.content).fadeIn().next(".cpm-msg-edit-form").html("")}$(".cpm-loading").remove()})},get:function(e){e.preventDefault();var t=$(this),n=t.closest(".cpm-single"),r={message_id:t.data("msg_id"),project_id:t.data("project_id"),action:"cpm_message_get",_wpnonce:CPM_Vars.nonce};$.post(CPM_Vars.ajaxurl,r,function(e){e=$.parseJSON(e);if(e.success){n.find(".cpm-entry-detail").hide().next(".cpm-msg-edit-form").hide().html(e.content).fadeIn();new CPM_Uploader("cpm-upload-pickfiles-"+e.id,"cpm-upload-container-"+e.id)}})},hideEditForm:function(e){e.preventDefault();var t=$(this).closest(".cpm-single");t.find(".cpm-entry-detail").fadeIn().next(".cpm-msg-edit-form").fadeOut(function(){$(this).html("")})},remove:function(e){e.preventDefault();var t=$(this),n={message_id:t.data("msg_id"),project_id:t.data("project_id"),action:"cpm_message_delete",_wpnonce:CPM_Vars.nonce};if(confirm(t.data("confirm"))){t.css("opacity","1").addClass("cpm-messages-spinner");$.post(CPM_Vars.ajaxurl,n,function(e){e=$.parseJSON(e);e.success&&(window.location.href=e.url)})}}}};$(function(){weDevs_CPM.init();$(".chosen-select").chosen({width:"300px"});$(".cpm-timetraker").on("click",function(){$(this).runner("start")});$(".datepicker").datepicker();if(!$(".cpm-project-coworker").length)return;$(".cpm-project-coworker").autocomplete({minLength:3,source:function(request,response){var data={action:"cpm_user_autocomplete",term:request.term};$.post(CPM_Vars.ajaxurl,data,function(resp){if(resp.success){var nme=eval(resp.data);response(eval(resp.data))}else response("")})},search:function(){$(this).addClass("cpm-spinner")},open:function(){var e=$(this);e.autocomplete("widget").css("z-index",9999);e.removeClass("cpm-spinner");return!1},select:function(e,t){if(t.item.value=="cpm_create_user"){$("form.cpm-user-create-form").find("input[type=text]").val("");$("#cpm-create-user-wrap").dialog("open")}else{$(".cpm-project-role>table").append(t.item._user_meta);$("input.cpm-project-coworker").val("")}return!1}}).data("ui-autocomplete")._renderItem=function(e,t){return $("<li>").append("<a>"+t.label+"</a>").appendTo(e)};$(".cpm-project-form").on("click",".cpm-project-role .cpm-del-proj-role",function(){$(this).closest("tr").remove()})})})(jQuery);